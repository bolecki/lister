{% load list_extras %}

<div class="col-lg-6">
    <div id="sortList" class="list-group">
        {% if items %}
            {% for item in items %}
                <div class="list-group-item">
                    <button class="close edit" onclick="update({{ item.id }}, 'delete')" type=submit>&times;</button>
                    {% if not voted %}
                        {% if not sortable %}
                        <button class="btn btn-xs btn-primary fa fa-arrow-up vote up-vote" onclick="update({{ item.id }}, 'up')" type=submit></button>
                        {% endif %}
                    {% else %}
                        {% if item.item_text == voted %}
                            <button class="btn btn-xs btn-danger fa fa-arrow-down vote down-vote" onclick="update({{ item.id }}, 'down')" type=submit></button>
                        {% endif %}
                    {% endif %}
                    <span title="{{ item.users.all|usernames }}"> {{ item.votes }} {{ item.item_text }}</span>
                </div>
            {% endfor %}
        {% endif %}
    </div>
    {% if not sortable %}
    <div class="row">
        <div class="col-md-6 form-group">
            <button class="btn btn-xs btn-primary" id="random">Random</button>
            {% if items.0.votes == items.1.votes %}
                <button class="btn btn-xs btn-primary" id="tie-breaker">Tie Breaker</button>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="edit panel panel-primary">
        <div class="panel-heading">
            <h3 class="panel-title">Edit List</h3>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-lg-6">
                    <form role="form" action="{% url 'lists:lister' list_id %}" method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label>Add Item</label>
                            <input class="form-control" type="text" name="add" id="add" placeholder="Item name" value="" />
                        </div>
                        <div class="form-group">
                            <button class="btn btn-xs btn-primary" type="submit">Add</button>
                        </div>
                    </form>
                </div>
                {% if mine %}
                <div class="col-lg-6">
                    <form role="form" class="edit" action="{% url 'lists:grant' list_id %}" method="post">
                        <label>Grant Users Access</label>
                        <div class="form-group">
                            {% csrf_token %}
                            {{ grant_form }}
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-xs btn-primary">Grant</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <button type="submit" class="edit btn btn-sm btn-primary" onclick="update({{ items.0.id }}, 'clear')">Clear Votes</button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<!-- /.col-sm-4 -->
{% if num_votes %}
<div class="col-lg-3 col-md-6">
    <div class="panel panel-primary">
        <div class="panel-heading">
            <div class="row">
                <div class="col-xs-3">
                    <i class="fa fa-check-square fa-5x"></i>
                </div>
                <div class="col-xs-9 text-right">
                    <div class="huge">{{ num_votes.votes__sum }}</div>
                    <div>Votes</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="col-lg-3 col-md-6"></div>
{% endif %}
<div class="col-lg-3 col-md-6">
    <div class="panel panel-primary">
        <div class="panel-heading">
            <div class="row">
                <div class="col-xs-3">
                    <i class="fa fa-list fa-5x"></i>
                </div>
                <div class="col-xs-9 text-right">
                    <div class="huge">{{ items|length }}</div>
                    <div>Items</div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">

if($("#toggle-edit").html() == "Stop Editing"){
  $(".edit").show();
}

{% if sortable %}
Sortable.create(sortList, {
  animation: 150,
  onEnd: function (/**Event*/evt) {
    var url = "{% url 'lists:sort' list_id=list_id old_index=99999 new_index=99998 %}";

    url = url.replace('99999', evt.oldIndex);
    url = url.replace('99998', evt.newIndex);

    $.post(url, function(){});
  },
});

{% else %}

var randomText = "Random: ";

$("#random").click(function(){
  $("#selected").html("Loading...");
  $.get("{% url 'api:random' list_id=list_id %}", function(data){
    $("#selected").html(randomText + data);
  });
});

$("#tie-breaker").click(function(){
  $("#selected").html("Loading...");
  $.get("{% url 'api:random' list_id=list_id option='tie' %}", function(data){
    $("#selected").html(randomText + data);
  });
});
{% endif %}
</script>
